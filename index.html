<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chet</title>
    
    <style>
@tailwind base;
@tailwind components;
@tailwind utilities;

/* NEW: Add this custom button style at the end.
  This bundles all the styling into one class.
*/
.hub-button {
  @apply flex flex-col items-center justify-center p-6 bg-white dark:bg-gray-700 rounded-lg shadow-md text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors duration-200 cursor-pointer;
}

        /* Light mode scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #cbd5e1; /* gray-300 */
            border-radius: 3px;
        }
        ::-webkit-scrollbar-track {
            background-color: #f1f5f9; /* gray-100 */
        }

        /* Dark mode scrollbar */
        .dark ::-webkit-scrollbar-thumb {
            background-color: #4b5563; /* gray-600 */
        }
        .dark ::-webkit-scrollbar-track {
            background-color: #374151; /* gray-700 */
        }

        /* Simple CSS for the toggle switch */
        .toggle-checkbox:checked + .toggle-label {
            background-color: #3b82f6; /* blue-500 */
        }
        .toggle-checkbox:checked + .toggle-label .toggle-ball {
            transform: translateX(1.25rem); /* 20px */
        }

        /* Custom styles for system messages */
        .system-message {
            @apply text-center text-sm italic text-gray-500 dark:text-gray-400 my-2;
        }

        /* Banned message overlay */
        #banned-overlay {
            display: none; /* Hidden by default */
            @apply fixed inset-0 bg-gray-900 bg-opacity-90 flex items-center justify-center z-50 text-white text-center p-4;
        }

        /* Tab button styles */
        .tab-btn {
            @apply py-3 px-6 text-center font-medium text-gray-500 dark:text-gray-400 border-b-2 border-transparent hover:text-gray-700 dark:hover:text-gray-300;
        }
        .tab-btn.active {
            @apply text-blue-600 dark:text-blue-400 border-blue-600 dark:border-blue-400;
        }
        
    </style>

</head>
<body class="font-sans h-full flex flex-row transition-colors duration-300 bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100">

    <div id="sidebar" class="hidden w-64 h-full bg-white dark:bg-gray-800 shadow-lg flex flex-col border-r border-gray-200 dark:border-gray-700">
        <div class="flex-1 flex flex-col overflow-y-auto p-4">
            <h3 class="text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-3">Online Users</h3>
            <div id="user-list" class="space-y-2">
                <p class="text-sm text-gray-500 dark:text-gray-400 italic">Connecting...</p>
            </div>
        </div>
        
        <div class="p-4 border-t border-gray-200 dark:border-gray-700 space-y-2">
            <button id="open-settings-btn" class="w-full flex items-center space-x-3 px-4 py-2 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.096 2.573-1.066z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                <span>Settings</span>
            </button>
            <button id="open-admin-btn" class="w-full flex items-center space-x-3 px-4 py-2 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                <span>Admin Panel</span>
            </button>
        </div>
    </div>

    <main id="main-content" class="flex-1 h-full flex flex-col items-center justify-center overflow-y-auto p-4 md:p-8">
        <div id="username-modal" class="bg-white dark:bg-gray-800 w-full max-w-sm p-6 rounded-lg shadow-2xl z-20">
            <h2 class="text-2xl font-bold text-center text-gray-900 dark:text-gray-100 mb-6">Join Chat</h2>
            <div class="space-y-4">
                <div>
                    <label for="join-username-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Choose a Username</label>
                    <input type="text" id="join-username-input" placeholder="e.g., ChatUser123" class="w-full mt-1 px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:placeholder-gray-400">
                </div>
                <button id="join-chat-btn" class="w-full bg-blue-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-blue-700 transition-colors">
                    Join
                </button>
                <p id="join-error-msg" class="text-sm text-red-500 dark:text-red-400 text-center h-4"></p>
            </div>
        </div>

        <nav id="main-tabs" class="hidden flex w-full max-w-2xl border-b border-gray-200 dark:border-gray-700">
            <button id="chat-tab-btn" class="tab-btn active">Chat</button>
            <button id="hub-tab-btn" class="tab-btn">Hub</button>
        </nav>
        
        <div id="chat-container" class="hidden flex flex-col h-[90vh] w-full max-w-2xl bg-white dark:bg-gray-800 shadow-xl rounded-b-lg overflow-hidden">
            <header class="bg-blue-600 dark:bg-blue-700 text-white p-4 flex justify-between items-center">
                <h1 class="text-2xl font-bold">Chet</h1>
            </header>

            <main id="chat-messages" class="flex-1 p-4 flex flex-col space-y-3 overflow-y-auto bg-gray-50 dark:bg-gray-700">
                </main>

            <footer class="bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 p-4">
                <div id="typing-indicator" class="h-5 text-sm italic text-gray-500 dark:text-gray-400 mb-2"></div>
                
                <form id="message-form" class="flex space-x-3">
                    <input 
                        type="text" 
                        id="message-input"
                        placeholder="Type your message..."
                        autocomplete="off"
                        class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 dark:placeholder-gray-400"
                        required
                    >
                    <button 
                        type="submit" 
                        id="send-button"
                        class="bg-blue-600 dark:bg-blue-700 text-white px-6 py-2 rounded-full font-semibold hover:bg-blue-700 dark:hover:bg-blue-800 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors duration-200"
                    >
                        Send
                    </button>
                </form>
            </footer>
        </div>

        <div id="hub-main-content" class="hidden w-full max-w-2xl h-[90vh] bg-white dark:bg-gray-800 rounded-b-lg shadow-xl p-6 overflow-y-auto">
             <h2 class="text-2xl font-semibold mb-4">Hub</h2>
             
             <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                
                <a href="#" class="hub-button">
                    <svg class="w-10 h-10 mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 016 3.75h2.25A2.25 2.25 0 0110.5 6v2.25a2.25 2.25 0 01-2.25 2.25H6a2.25 2.25 0 01-2.25-2.25V6zM3.75 15.75A2.25 2.25 0 016 13.5h2.25a2.25 2.25 0 012.25 2.25V18a2.25 2.25 0 01-2.25 2.25H6A2.25 2.25 0 013.75 18v-2.25zM13.5 6a2.25 2.25 0 012.25-2.25H18A2.25 2.25 0 0120.25 6v2.25A2.25 2.25 0 0118 10.5h-2.25a2.25 2.25 0 01-2.25-2.25V6zM13.5 15.75a2.25 2.25 0 012.25-2.25H18a2.25 2.25 0 012.25 2.25V18A2.25 2.25 0 0118 20.25h-2.25A2.25 2.25 0 0113.5 18v-2.25z" />
                    </svg>
                    <span class="font-semibold text-sm">App Link 1</span>
                </a>

                <a href="#" class="hub-button">
                    <svg class="w-10 h-10 mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                         <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18L9 11.25l4.306 4.307a11.95 11.95 0 015.814-5.519l2.74-1.22m0 0l-5.94-2.28m5.94 2.28l-2.28 5.941" />
                    </svg>
                    <span class="font-semibold text-sm">Another App</span>
                </a>

                </div>
        </div>
    </main>
    
    <div id="settings-modal" class="fixed inset-0 z-10 overflow-y-auto hidden">
        <div id="settings-overlay" class="fixed inset-0 bg-black bg-opacity-50"></div>
        <div class="relative bg-white dark:bg-gray-800 w-full max-w-md mx-auto my-20 p-6 rounded-lg shadow-xl z-20">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-900 dark:text-gray-100">Settings</h2>
                <button id="close-settings-btn" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="space-y-6">
                <div class="flex items-center justify-between">
                    <span class="text-gray-700 dark:text-gray-300">Dark Mode</span>
                    <label for="dark-mode-toggle" class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="dark-mode-toggle" class="sr-only toggle-checkbox">
                        <div class="toggle-label w-11 h-6 bg-gray-200 dark:bg-gray-600 rounded-full transition-colors">
                            <div class="toggle-ball w-5 h-5 bg-white rounded-full shadow-md transform transition-transform duration-300 ease-in-out"></div>
                        </div>
                    </label>
                </div>
                <div class="space-y-2">
                    <label for="name-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Change Your Name</label>
                    <div class="flex space-x-2">
                        <input type="text" id="name-input" placeholder="Enter your name" class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:placeholder-gray-400">
                        <button id="save-name-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-blue-700 transition-colors">Save</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="admin-modal" class="fixed inset-0 z-10 overflow-y-auto hidden">
        <div id="admin-overlay" class="fixed inset-0 bg-black bg-opacity-50"></div>
        <div class="relative bg-white dark:bg-gray-800 w-full max-w-md mx-auto my-20 p-6 rounded-lg shadow-xl z-20">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-900 dark:text-gray-100">Admin Panel</h2>
                <button id="close-admin-btn" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="space-y-4">
                <div id="admin-login-view" class="space-y-4">
                    <label for="admin-password-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Admin Password</label>
                    <div class="flex space-x-2">
                        <input type="password" id="admin-password-input" class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button id="admin-login-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-blue-700 transition-colors">Login</button>
                    </div>
                </div>
                <div id="admin-controls-view" class="hidden space-y-6">
                    <p class="text-green-600 dark:text-green-400">Admin login successful.</p>
                    <div>
                        <label for="admin-broadcast-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300">System Broadcast</label>
                        <div class="flex space-x-2 mt-1">
                            <input type="text" id="admin-broadcast-input" placeholder="Message to all users" class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button id="admin-broadcast-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-blue-700 transition-colors">Send</button>
                        </div>
                    </div>
                    <div>
                        <label for="admin-username-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Moderate User</label>
                        <input type="text" id="admin-username-input" placeholder="Enter username (case-insensitive)" class="w-full mt-1 px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <div class="flex space-x-2 mt-2">
                            <button id="admin-warn-btn" class="flex-1 bg-yellow-500 text-white px-4 py-2 rounded-md font-semibold hover:bg-yellow-600 transition-colors">Warn</button>
                            <button id="admin-mute-btn" class="flex-1 bg-orange-500 text-white px-4 py-2 rounded-md font-semibold hover:bg-orange-600 transition-colors">Mute (5m)</button>
                            <button id="admin-ban-btn" class="flex-1 bg-red-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-red-700 transition-colors">Ban</button>
                        </div>
                    </div>
                    <div>
                        <label for="admin-word-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Manage Banned Words</label>
                        <div class="flex space-x-2 mt-1">
                            <input type="text" id="admin-word-input" placeholder="Add/Remove a word" class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button id="admin-add-word-btn" class="bg-green-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-green-700 transition-colors">Add</button>
                            <button id="admin-remove-word-btn" class="bg-red-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-red-700 transition-colors">Del</button>
                        </div>
                        <div id="banned-words-list" class="mt-2 p-2 h-24 overflow-y-auto bg-gray-100 dark:bg-gray-700 rounded-md text-gray-700 dark:text-gray-300 text-sm">
                            Banned words will appear here...
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Banned Users</label>
                        <div id="banned-users-list" class="mt-2 p-2 h-32 overflow-y-auto bg-gray-100 dark:bg-gray-700 rounded-md text-gray-700 dark:text-gray-300 text-sm space-y-2">
                            <p>No banned users.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="banned-overlay">
        <div class="flex flex-col items-center">
            <svg class="w-16 h-16 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path></svg>
            <h2 class="text-3xl font-bold mt-4">You have been banned.</h2>
            <p class="mt-2 text-lg text-gray-300">You are not permitted to access this chat.</p>
            <a id="unban-link" href="#" target="_blank" rel="noopener noreferrer" class="mt-6 px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors">
                Submit an Unban Appeal
            </a>
        </div>
    </div>


    <script>
        // --- NEW: Global state for typing ---
        let myUsername = '';
        let typingTimer = null;
        let isTyping = false;

        // --- DOM Elements ---
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('main-content');
        const usernameModal = document.getElementById('username-modal');
        const joinUsernameInput = document.getElementById('join-username-input');
        const joinChatBtn = document.getElementById('join-chat-btn');
        const joinErrorMsg = document.getElementById('join-error-msg');

        const chatContainer = document.getElementById('chat-container');
        const chatMessages = document.getElementById('chat-messages');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');

        // --- NEW/MODIFIED Tab Elements ---
        const mainTabs = document.getElementById('main-tabs');
        const chatTabBtn = document.getElementById('chat-tab-btn');
        const hubTabBtn = document.getElementById('hub-tab-btn');
        const hubMainContent = document.getElementById('hub-main-content');
        const userList = document.getElementById('user-list');
        const typingIndicator = document.getElementById('typing-indicator'); // <-- NEW

        // --- Settings Modal Elements ---
        const settingsModal = document.getElementById('settings-modal');
        const settingsOverlay = document.getElementById('settings-overlay');
        const openSettingsBtn = document.getElementById('open-settings-btn');
        const closeSettingsBtn = document.getElementById('close-settings-btn');
        const nameInput = document.getElementById('name-input');
        const saveNameBtn = document.getElementById('save-name-btn');
        
        // --- Admin Modal Elements ---
        const adminModal = document.getElementById('admin-modal');
        const adminOverlay = document.getElementById('admin-overlay');
        const openAdminBtn = document.getElementById('open-admin-btn');
        const closeAdminBtn = document.getElementById('close-admin-btn');
        const adminLoginView = document.getElementById('admin-login-view');
        const adminPasswordInput = document.getElementById('admin-password-input');
        const adminLoginBtn = document.getElementById('admin-login-btn');
        
        // --- Admin Controls ---
        const adminControlsView = document.getElementById('admin-controls-view');
        const adminBroadcastInput = document.getElementById('admin-broadcast-input');
        const adminBroadcastBtn = document.getElementById('admin-broadcast-btn');
        const adminUsernameInput = document.getElementById('admin-username-input');
        const adminWarnBtn = document.getElementById('admin-warn-btn');
        const adminMuteBtn = document.getElementById('admin-mute-btn');
        const adminBanBtn = document.getElementById('admin-ban-btn');
        const adminWordInput = document.getElementById('admin-word-input');
        const adminAddWordBtn = document.getElementById('admin-add-word-btn');
        const adminRemoveWordBtn = document.getElementById('admin-remove-word-btn');
        const bannedWordsList = document.getElementById('banned-words-list');
        const bannedUsersList = document.getElementById('banned-users-list');
        
        // --- Banned Overlay ---
        const bannedOverlay = document.getElementById('banned-overlay');
        const unbanLink = document.getElementById('unban-link');

        // --- Dark Mode Elements ---
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const htmlElement = document.documentElement; // The <html> tag

        // --- Dark Mode Logic ---
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            htmlElement.classList.add('dark');
            darkModeToggle.checked = true;
        } else {
            htmlElement.classList.remove('dark');
            darkModeToggle.checked = false;
        }

        darkModeToggle.addEventListener('change', () => {
            if (darkModeToggle.checked) {
                htmlElement.classList.add('dark');
                localStorage.theme = 'dark';
            } else {
                htmlElement.classList.remove('dark');
                localStorage.theme = 'light';
            }
        });

        // --- Settings Modal Logic ---
        function openSettingsModal() { settingsModal.classList.remove('hidden'); }
        function closeSettingsModal() { settingsModal.classList.add('hidden'); }
        openSettingsBtn.addEventListener('click', openSettingsModal);
        closeSettingsBtn.addEventListener('click', closeSettingsModal);
        settingsOverlay.addEventListener('click', closeSettingsModal);

        // --- Admin Modal Logic ---
        function openAdminModal() { adminModal.classList.remove('hidden'); }
        function closeAdminModal() { adminModal.classList.add('hidden'); }
        openAdminBtn.addEventListener('click', openAdminModal);
        closeAdminBtn.addEventListener('click', closeAdminModal);
        adminOverlay.addEventListener('click', closeAdminModal);

        // --- NEW: Main Tab Switching Logic ---
        chatTabBtn.addEventListener('click', () => {
            chatTabBtn.classList.add('active');
            hubTabBtn.classList.remove('active');
            chatContainer.classList.remove('hidden');
            chatContainer.classList.add('flex');
            hubMainContent.classList.add('hidden');
        });

        hubTabBtn.addEventListener('click', () => {
            hubTabBtn.classList.add('active');
            chatTabBtn.classList.remove('active');
            hubMainContent.classList.remove('hidden');
            chatContainer.classList.add('hidden');
            chatContainer.classList.remove('flex');
        });

        
        // --- WebSocket Connection ---
        const wsProtocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
        const ws = new WebSocket(wsProtocol + window.location.host);
        
        /**
         * Sends a structured JSON message to the WebSocket server.
         * @param {object} data The data object to send.
         */
        function sendSocketMessage(data) {
            if (ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(data));
            }
        }

        // --- Helper Functions to display messages ---
        function displayMessage(name, text, isMe = false) {
            const messageWrapper = document.createElement('div');
            messageWrapper.classList.add('flex', 'flex-col');

            const nameElement = document.createElement('strong');
            nameElement.classList.add('text-sm', 'text-gray-600', 'dark:text-gray-400');
            
            const messageElement = document.createElement('div');
            messageElement.textContent = text;
            messageElement.classList.add('p-2', 'rounded-lg', 'max-w-xs', 'break-words', 'mt-1');
            
            if (isMe) {
                nameElement.textContent = 'You';
                messageWrapper.classList.add('self-end', 'items-end');
                messageElement.classList.add('bg-blue-500', 'text-white', 'ml-auto');
            } else {
                nameElement.textContent = name;
                messageWrapper.classList.add('self-start', 'items-start');
                messageElement.classList.add('bg-gray-200', 'text-gray-800', 'dark:bg-gray-600', 'dark:text-gray-200');
            }

            messageWrapper.appendChild(nameElement);
            messageWrapper.appendChild(messageElement);
            chatMessages.appendChild(messageWrapper);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function displaySystemMessage(text) {
            const messageElement = document.createElement('div');
            messageElement.textContent = text;
            messageElement.classList.add('system-message'); // Uses custom style
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function showBannedScreen(link) {
            unbanLink.href = link;
            mainContent.style.display = 'none'; // Hide the whole main area
            sidebar.style.display = 'none'; // Hide the sidebar
            bannedOverlay.style.display = 'flex'; // Show the ban message
        }

        function updateBannedWordList(words) {
            if (words.length === 0) {
                bannedWordsList.textContent = 'No banned words yet.';
                return;
            }
            bannedWordsList.innerHTML = '';
            words.forEach(word => {
                const wordEl = document.createElement('span');
                wordEl.textContent = word;
                wordEl.classList.add('inline-block', 'bg-gray-200', 'dark:bg-gray-600', 'rounded-full', 'px-2', 'py-1', 'text-xs', 'mr-1', 'mb-1');
                bannedWordsList.appendChild(wordEl);
            });
        }

        function updateBannedUserList(users) {
            bannedUsersList.innerHTML = ''; // Clear the list
            if (users.length === 0) {
                bannedUsersList.innerHTML = '<p>No banned users.</p>';
                return;
            }

            users.forEach(user => {
                const userEl = document.createElement('div');
                userEl.classList.add('flex', 'justify-between', 'items-center', 'p-2', 'bg-gray-200', 'dark:bg-gray-600', 'rounded');
                
                const userInfo = document.createElement('span');
                userInfo.textContent = `${user.username}`;
                
                const unbanBtn = document.createElement('button');
                unbanBtn.textContent = 'Unban';
                unbanBtn.classList.add('bg-green-600', 'text-white', 'px-2', 'py-1', 'text-xs', 'rounded', 'hover:bg-green-700');
                
                unbanBtn.addEventListener('click', () => {
                    sendSocketMessage({ type: 'adminUnban', name: user.username });
                });

                userEl.appendChild(userInfo);
                userEl.appendChild(unbanBtn);
                bannedUsersList.appendChild(userEl);
            });
        }

        function updateUserList(usernames) {
            userList.innerHTML = ''; // Clear the list
            if (usernames.length === 0) {
                userList.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400 italic">No one is online.</p>';
                return;
            }
            
            usernames.sort((a, b) => a.toLowerCase().localeCompare(b.toLowerCase()));
            
            usernames.forEach(name => {
                const userEl = document.createElement('div');
                userEl.textContent = name;
                userEl.classList.add('text-gray-700', 'dark:text-gray-300');
                userList.appendChild(userEl);
            });
        }

        function updateTypingIndicator(users) {
            // Filter out our own username
            const otherTypers = users.filter(name => name !== myUsername);

            if (otherTypers.length === 0) {
                typingIndicator.textContent = '';
            } else if (otherTypers.length === 1) {
                typingIndicator.textContent = `${otherTypers[0]} is typing...`;
            } else if (otherTypers.length === 2) {
                typingIndicator.textContent = `${otherTypers[0]} and ${otherTypers[1]} are typing...`;
            } else {
                typingIndicator.textContent = 'Several people are typing...';
            }
        }


        // --- WebSocket Event Handlers ---
        ws.onopen = () => {
            console.log('Connected to WebSocket server');
        };

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            console.log('Message from server:', data);

            switch (data.type) {
                case 'joinSuccess':
                    usernameModal.classList.add('hidden');
                    sidebar.classList.remove('hidden');
                    sidebar.classList.add('flex');
                    
                    mainTabs.classList.remove('hidden');
                    mainTabs.classList.add('flex');
                    chatContainer.classList.remove('hidden');
                    chatContainer.classList.add('flex');

                    mainContent.classList.remove('justify-center', 'p-4', 'md:p-8');
                    mainContent.classList.add('pt-8');
                    
                    chatMessages.innerHTML = '';
                    displaySystemMessage('Welcome to the chat! ' + data.text);
                    break;
                
                case 'joinError':
                    joinErrorMsg.textContent = data.text;
                    joinChatBtn.disabled = false;
                    break;

                case 'message':
                    displayMessage(data.name, data.text, false);
                    break;
                case 'system':
                    displaySystemMessage(data.text);
                    break;
                case 'adminSuccess':
                    displaySystemMessage('Admin login successful.');
                    adminLoginView.classList.add('hidden');
                    adminControlsView.classList.remove('hidden');
                    break;
                case 'banned':
                    showBannedScreen(data.link);
                    ws.close();
                    break;
                case 'bannedWordList':
                    updateBannedWordList(data.words);
                    break;
                case 'bannedUserList':
                    updateBannedUserList(data.users);
                    break;
                
                case 'userList':
                    updateUserList(data.users);
                    break;
                
                case 'typingUsers':
                    updateTypingIndicator(data.users);
                    break;
            }
        };

        ws.onclose = () => {
            console.log('Disconnected from WebSocket server');
            if (bannedOverlay.style.display !== 'flex') {
                displaySystemMessage('You have been disconnected. Please refresh the page to reconnect.');
                sendButton.disabled = true;
                messageInput.disabled = true;
                userList.innerHTML = '<p class="text-sm text-red-500 dark:text-red-400 italic">Disconnected.</p>';
            }
        };

        ws.onerror = (error) => {
            console.error('WebSocket Error:', error);
            if (!chatContainer.classList.contains('hidden')) {
                displaySystemMessage('A connection error occurred.');
            } else {
                joinErrorMsg.textContent = 'Could not connect to server.';
            }
        };

        // --- Form Submission Handlers ---
        joinChatBtn.addEventListener('click', () => {
            const name = joinUsernameInput.value;
            if (!name) {
                joinErrorMsg.textContent = 'Username cannot be empty.';
                return;
            }
            
            myUsername = name;
            joinErrorMsg.textContent = '';
            joinChatBtn.disabled = true;
            
            sendSocketMessage({
                type: 'setName',
                name: name
            });
        });
        
        messageForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const message = messageInput.value;
            if (!message) return;

            clearTimeout(typingTimer);
            if (isTyping) {
                sendSocketMessage({ type: 'stopTyping' });
                isTyping = false;
            }

            sendSocketMessage({
                type: 'message',
                text: message
            });
            
            displayMessage('You', message, true);
            messageInput.value = '';
        });

        saveNameBtn.addEventListener('click', () => {
            const name = nameInput.value;
            if (!name) return;

            myUsername = name;
            sendSocketMessage({
                type: 'setName',
                name: name
            });
            
            closeSettingsModal();
        });

        adminLoginBtn.addEventListener('click', () => {
            const password = adminPasswordInput.value;
            if (!password) return;

            sendSocketMessage({
                type: 'adminLogin',
                password: password
            });
            adminPasswordInput.value = '';
        });
        
        adminBroadcastBtn.addEventListener('click', () => {
            const message = adminBroadcastInput.value;
            if (!message) return;
            sendSocketMessage({ type: 'adminBroadcast', text: message });
            adminBroadcastInput.value = '';
        });
        
        // --- Admin Action Handlers ---
        adminWarnBtn.addEventListener('click', () => {
            const name = adminUsernameInput.value;
            if (!name) return;
            sendSocketMessage({ type: 'adminWarn', name: name });
            adminUsernameInput.value = '';
        });

        adminMuteBtn.addEventListener('click', () => {
            const name = adminUsernameInput.value;
            if (!name) return;
            sendSocketMessage({ type: 'adminMute', name: name });
            adminUsernameInput.value = '';
        });

        adminBanBtn.addEventListener('click', () => {
            const name = adminUsernameInput.value;
            if (!name) return;
            sendSocketMessage({ type: 'adminBan', name: name });
            adminUsernameInput.value = '';
        });
        
        adminAddWordBtn.addEventListener('click', () => {
            const word = adminWordInput.value;
            if (!word) return;
            sendSocketMessage({ type: 'adminAddWord', word: word });
            adminWordInput.value = '';
        });
        
        adminRemoveWordBtn.addEventListener('click', () => {
            const word = adminWordInput.value;
            if (!word) return;
            sendSocketMessage({ type: 'adminRemoveWord', word: word });
            adminWordInput.value = '';
        });

        // --- NEW: Typing Indicator Logic ---
        messageInput.addEventListener('keyup', () => {
            clearTimeout(typingTimer); // Reset the timer

            if (!isTyping) {
                sendSocketMessage({ type: 'startTyping' });
                isTyping = true;
            }

            typingTimer = setTimeout(() => {
                sendSocketMessage({ type: 'stopTyping' });
                isTyping = false;
            }, 2000); // 2-second timeout
        });
    </script>
</body>
</html>
