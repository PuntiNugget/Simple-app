<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Node.js Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            // Enable 'class' strategy for dark mode
            darkMode: 'class', 
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    <style>
        /* Light mode scrollbar */
        #chat-messages::-webkit-scrollbar {
            width: 6px;
        }
        #chat-messages::-webkit-scrollbar-thumb {
            background-color: #cbd5e1; /* gray-300 */
            border-radius: 3px;
        }
        #chat-messages::-webkit-scrollbar-track {
            background-color: #f1f5f9; /* gray-100 */
        }

        /* Dark mode scrollbar */
        .dark #chat-messages::-webkit-scrollbar-thumb {
            background-color: #4b5563; /* gray-600 */
        }
        .dark #chat-messages::-webkit-scrollbar-track {
            background-color: #374151; /* gray-700 */
        }

        /* Simple CSS for the toggle switch */
        .toggle-checkbox:checked + .toggle-label {
            background-color: #3b82f6; /* blue-500 */
        }
        .toggle-checkbox:checked + .toggle-label .toggle-ball {
            transform: translateX(1.25rem); /* 20px */
        }

        /* Custom styles for system messages */
        .system-message {
            @apply text-center text-sm italic text-gray-500 dark:text-gray-400 my-2;
        }

        /* Banned message overlay */
        #banned-overlay {
            display: none; /* Hidden by default */
            @apply fixed inset-0 bg-gray-900 bg-opacity-90 flex items-center justify-center z-50 text-white text-center p-4;
        }
    </style>
</head>
<body class="font-sans h-full flex items-center justify-center transition-colors duration-300 bg-gray-100 dark:bg-gray-900">

    <div id="username-modal" class="bg-white dark:bg-gray-800 w-full max-w-sm p-6 rounded-lg shadow-2xl z-20">
        <h2 class="text-2xl font-bold text-center text-gray-900 dark:text-gray-100 mb-6">Join Chat</h2>
        <div class="space-y-4">
            <div>
                <label for="join-username-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Choose a Username</label>
                <input type="text" id="join-username-input" placeholder="e.g., ChatUser123" class="w-full mt-1 px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:placeholder-gray-400">
            </div>
            <button id="join-chat-btn" class="w-full bg-blue-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-blue-700 transition-colors">
                Join
            </button>
            <p id="join-error-msg" class="text-sm text-red-500 dark:text-red-400 text-center h-4"></p>
        </div>
    </div>

    <div id="chat-container" class="hidden flex flex-col h-[90vh] w-full max-w-2xl bg-white dark:bg-gray-800 shadow-2xl rounded-lg overflow-hidden">
        <header class="bg-blue-600 dark:bg-blue-700 text-white p-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold">Node.js Chat</h1>
            <div class="flex space-x-2">
                <button id="open-admin-btn" class="p-2 rounded-full hover:bg-blue-500 dark:hover:bg-blue-600 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                </button>
                <button id="open-settings-btn" class="p-2 rounded-full hover:bg-blue-500 dark:hover:bg-blue-600 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.096 2.573-1.066z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                </button>
            </div>
        </header>

        <main id="chat-messages" class="flex-1 p-4 flex flex-col space-y-3 overflow-y-auto bg-gray-50 dark:bg-gray-700">
            </main>

        <footer class="bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 p-4">
            <form id="message-form" class="flex space-x-3">
                <input 
                    type="text" 
                    id="message-input"
                    placeholder="Type your message..."
                    autocomplete="off"
                    class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 dark:placeholder-gray-400"
                    required
                >
                <button 
                    type="submit" 
                    id="send-button"
                    class="bg-blue-600 dark:bg-blue-700 text-white px-6 py-2 rounded-full font-semibold hover:bg-blue-700 dark:hover:bg-blue-800 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors duration-200"
                >
                    Send
                </button>
            </form>
        </footer>
    </div>

    <div id="settings-modal" class="fixed inset-0 z-10 overflow-y-auto hidden">
        <div id="settings-overlay" class="fixed inset-0 bg-black bg-opacity-50"></div>
        <div class="relative bg-white dark:bg-gray-800 w-full max-w-md mx-auto my-20 p-6 rounded-lg shadow-xl z-20">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-900 dark:text-gray-100">Settings</h2>
                <button id="close-settings-btn" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="space-y-6">
                <div class="flex items-center justify-between">
                    <span class="text-gray-700 dark:text-gray-300">Dark Mode</span>
                    <label for="dark-mode-toggle" class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="dark-mode-toggle" class="sr-only toggle-checkbox">
                        <div class="toggle-label w-11 h-6 bg-gray-200 dark:bg-gray-600 rounded-full transition-colors">
                            <div class="toggle-ball w-5 h-5 bg-white rounded-full shadow-md transform transition-transform duration-300 ease-in-out"></div>
                        </div>
                    </label>
                </div>
                <div class="space-y-2">
                    <label for="name-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Change Your Name</label>
                    <div class="flex space-x-2">
                        <input type="text" id="name-input" placeholder="Enter your name" class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:placeholder-gray-400">
                        <button id="save-name-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-blue-700 transition-colors">Save</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="admin-modal" class="fixed inset-0 z-10 overflow-y-auto hidden">
        <div id="admin-overlay" class="fixed inset-0 bg-black bg-opacity-50"></div>
        <div class="relative bg-white dark:bg-gray-800 w-full max-w-md mx-auto my-20 p-6 rounded-lg shadow-xl z-20">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-900 dark:text-gray-100">Admin Panel</h2>
                <button id="close-admin-btn" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="space-y-4">
                <div id="admin-login-view" class="space-y-4">
                    <label for="admin-password-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Admin Password</label>
                    <div class="flex space-x-2">
                        <input type="password" id="admin-password-input" class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button id="admin-login-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-blue-700 transition-colors">Login</button>
                    </div>
                </div>
                
                <div id="admin-controls-view" class="hidden space-y-6">
                    <p class="text-green-600 dark:text-green-400">Admin login successful.</p>
                    
                    <div>
                        <label for="admin-broadcast-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300">System Broadcast</label>
                        <div class="flex space-x-2 mt-1">
                            <input type="text" id="admin-broadcast-input" placeholder="Message to all users" class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button id="admin-broadcast-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-blue-700 transition-colors">Send</button>
                        </div>
                    </div>

                    <div>
                        <label for="admin-username-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Moderate User</label>
                        <input type="text" id="admin-username-input" placeholder="Enter username (case-insensitive)" class="w-full mt-1 px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <div class="flex space-x-2 mt-2">
                            <button id="admin-warn-btn" class="flex-1 bg-yellow-500 text-white px-4 py-2 rounded-md font-semibold hover:bg-yellow-600 transition-colors">Warn</button>
                            <button id="admin-mute-btn" class="flex-1 bg-orange-500 text-white px-4 py-2 rounded-md font-semibold hover:bg-orange-600 transition-colors">Mute (5m)</button>
                            <button id="admin-ban-btn" class="flex-1 bg-red-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-red-700 transition-colors">Ban</button>
                        </div>
                    </div>

                    <div>
                        <label for="admin-word-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Manage Banned Words</label>
                        <div class="flex space-x-2 mt-1">
                            <input type="text" id="admin-word-input" placeholder="Add/Remove a word" class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button id="admin-add-word-btn" class="bg-green-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-green-700 transition-colors">Add</button>
                            <button id="admin-remove-word-btn" class="bg-red-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-red-700 transition-colors">Del</button>
                        </div>
                        <div id="banned-words-list" class="mt-2 p-2 h-24 overflow-y-auto bg-gray-100 dark:bg-gray-700 rounded-md text-gray-700 dark:text-gray-300 text-sm">
                            Banned words will appear here...
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Banned Users</label>
                        <div id="banned-users-list" class="mt-2 p-2 h-32 overflow-y-auto bg-gray-100 dark:bg-gray-700 rounded-md text-gray-700 dark:text-gray-300 text-sm space-y-2">
                            <p>No banned users.</p>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <div id="banned-overlay">
        <div class="flex flex-col items-center">
            <svg class="w-16 h-16 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path></svg>
            <h2 class="text-3xl font-bold mt-4">You have been banned.</h2>
            <p class="mt-2 text-lg text-gray-300">You are not permitted to access this chat.</p>
            <a id="unban-link" href="#" target="_blank" rel="noopener noreferrer" class="mt-6 px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors">
                Submit an Unban Appeal
            </a>
        </div>
    </div>


    <script>
        // --- DOM Elements ---
        const usernameModal = document.getElementById('username-modal');
        const joinUsernameInput = document.getElementById('join-username-input');
        const joinChatBtn = document.getElementById('join-chat-btn');
        const joinErrorMsg = document.getElementById('join-error-msg');

        const chatContainer = document.getElementById('chat-container');
        const chatMessages = document.getElementById('chat-messages');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');

        // --- Settings Modal Elements ---
        const settingsModal = document.getElementById('settings-modal');
        const settingsOverlay = document.getElementById('settings-overlay');
        const openSettingsBtn = document.getElementById('open-settings-btn');
        const closeSettingsBtn = document.getElementById('close-settings-btn');
        const nameInput = document.getElementById('name-input');
        const saveNameBtn = document.getElementById('save-name-btn');
        
        // --- Admin Modal Elements ---
        const adminModal = document.getElementById('admin-modal');
        const adminOverlay = document.getElementById('admin-overlay');
        const openAdminBtn = document.getElementById('open-admin-btn');
        const closeAdminBtn = document.getElementById('close-admin-btn');
        const adminLoginView = document.getElementById('admin-login-view');
        const adminPasswordInput = document.getElementById('admin-password-input');
        const adminLoginBtn = document.getElementById('admin-login-btn');
        
        // --- Admin Controls ---
        const adminControlsView = document.getElementById('admin-controls-view');
        const adminBroadcastInput = document.getElementById('admin-broadcast-input');
        const adminBroadcastBtn = document.getElementById('admin-broadcast-btn');
        const adminUsernameInput = document.getElementById('admin-username-input');
        const adminWarnBtn = document.getElementById('admin-warn-btn');
        const adminMuteBtn = document.getElementById('admin-mute-btn');
        const adminBanBtn = document.getElementById('admin-ban-btn');
        const adminWordInput = document.getElementById('admin-word-input');
        const adminAddWordBtn = document.getElementById('admin-add-word-btn');
        const adminRemoveWordBtn = document.getElementById('admin-remove-word-btn');
        const bannedWordsList = document.getElementById('banned-words-list');
        const bannedUsersList = document.getElementById('banned-users-list');
        
        // --- Banned Overlay ---
        const bannedOverlay = document.getElementById('banned-overlay');
        const unbanLink = document.getElementById('unban-link');

        // --- Dark Mode Elements ---
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const htmlElement = document.documentElement; // The <html> tag

        // --- Dark Mode Logic ---
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            htmlElement.classList.add('dark');
            darkModeToggle.checked = true;
        } else {
            htmlElement.classList.remove('dark');
            darkModeToggle.checked = false;
        }

        darkModeToggle.addEventListener('change', () => {
            if (darkModeToggle.checked) {
                htmlElement.classList.add('dark');
                localStorage.theme = 'dark';
            } else {
                htmlElement.classList.remove('dark');
                localStorage.theme = 'light';
            }
        });

        // --- Settings Modal Logic ---
        function openSettingsModal() { settingsModal.classList.remove('hidden'); }
        function closeSettingsModal() { settingsModal.classList.add('hidden'); }
        openSettingsBtn.addEventListener('click', openSettingsModal);
        closeSettingsBtn.addEventListener('click', closeSettingsModal);
        settingsOverlay.addEventListener('click', closeSettingsModal);

        // --- Admin Modal Logic ---
        function openAdminModal() { adminModal.classList.remove('hidden'); }
        function closeAdminModal() { adminModal.classList.add('hidden'); }
        openAdminBtn.addEventListener('click', openAdminModal);
        closeAdminBtn.addEventListener('click', closeAdminModal);
        adminOverlay.addEventListener('click', closeAdminModal);

        
        // --- WebSocket Connection ---
        const wsProtocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
        const ws = new WebSocket(wsProtocol + window.location.host);
        
        /**
         * Sends a structured JSON message to the WebSocket server.
         * @param {object} data The data object to send.
         */
        function sendSocketMessage(data) {
            if (ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(data));
            }
        }

        // --- Helper Functions to display messages ---

        /**
         * Displays a standard chat message.
         * @param {string} name The name of the sender.
         * @param {string} text The message text.
         * @param {boolean} isMe True if the message is from this client.
         */
        function displayMessage(name, text, isMe = false) {
            const messageWrapper = document.createElement('div');
            messageWrapper.classList.add('flex', 'flex-col');

            const nameElement = document.createElement('strong');
            nameElement.classList.add('text-sm', 'text-gray-600', 'dark:text-gray-400');
            
            const messageElement = document.createElement('div');
            messageElement.textContent = text;
            messageElement.classList.add('p-2', 'rounded-lg', 'max-w-xs', 'break-words', 'mt-1');
            
            if (isMe) {
                nameElement.textContent = 'You';
                messageWrapper.classList.add('self-end', 'items-end');
                messageElement.classList.add('bg-blue-500', 'text-white', 'ml-auto');
            } else {
                nameElement.textContent = name;
                messageWrapper.classList.add('self-start', 'items-start');
                messageElement.classList.add('bg-gray-200', 'text-gray-800', 'dark:bg-gray-600', 'dark:text-gray-200');
            }

            messageWrapper.appendChild(nameElement);
            messageWrapper.appendChild(messageElement);
            chatMessages.appendChild(messageWrapper);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        /**
         * Displays a system-level message (e.g., user join/leave).
         * @param {string} text The message text.
         */
        function displaySystemMessage(text) {
            const messageElement = document.createElement('div');
            messageElement.textContent = text;
            messageElement.classList.add('system-message'); // Uses custom style
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        /**
         * Shows the banned overlay.
         * @param {string} link The unban appeal URL.
         */
        function showBannedScreen(link) {
            unbanLink.href = link;
            usernameModal.style.display = 'none'; // Hide username modal
            chatContainer.style.display = 'none'; // Hide the chat
            bannedOverlay.style.display = 'flex'; // Show the ban message
        }

        /**
         * Updates the list of banned words in the admin panel.
         * @param {string[]} words Array of banned words.
         */
        function updateBannedWordList(words) {
            if (words.length === 0) {
                bannedWordsList.textContent = 'No banned words yet.';
                return;
            }
            bannedWordsList.innerHTML = '';
            words.forEach(word => {
                const wordEl = document.createElement('span');
                wordEl.textContent = word;
                wordEl.classList.add('inline-block', 'bg-gray-200', 'dark:bg-gray-600', 'rounded-full', 'px-2', 'py-1', 'text-xs', 'mr-1', 'mb-1');
                bannedWordsList.appendChild(wordEl);
            });
        }

        /**
         * Updates the list of banned users in the admin panel.
         * @param {Array<object>} users Array of user objects ({username}).
         */
        function updateBannedUserList(users) {
            bannedUsersList.innerHTML = ''; // Clear the list
            if (users.length === 0) {
                bannedUsersList.innerHTML = '<p>No banned users.</p>';
                return;
            }

            users.forEach(user => {
                const userEl = document.createElement('div');
                userEl.classList.add('flex', 'justify-between', 'items-center', 'p-2', 'bg-gray-200', 'dark:bg-gray-600', 'rounded');
                
                const userInfo = document.createElement('span');
                userInfo.textContent = `${user.username}`;
                
                const unbanBtn = document.createElement('button');
                unbanBtn.textContent = 'Unban';
                unbanBtn.classList.add('bg-green-600', 'text-white', 'px-2', 'py-1', 'text-xs', 'rounded', 'hover:bg-green-700');
                
                // Add click listener to send unban message
                unbanBtn.addEventListener('click', () => {
                    // MODIFIED: Send username, not IP
                    sendSocketMessage({ type: 'adminUnban', name: user.username });
                });

                userEl.appendChild(userInfo);
                userEl.appendChild(unbanBtn);
                bannedUsersList.appendChild(userEl);
            });
        }


        // --- WebSocket Event Handlers ---

        ws.onopen = () => {
            console.log('Connected to WebSocket server');
            // Don't clear messages, wait for join
        };

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            console.log('Message from server:', data);

            switch (data.type) {
                // NEW: Handle successful join
                case 'joinSuccess':
                    usernameModal.classList.add('hidden');
                    chatContainer.classList.remove('hidden');
                    chatContainer.classList.add('flex'); // Make sure flex is re-added
                    chatMessages.innerHTML = ''; // Clear "Connecting..."
                    displaySystemMessage('Welcome to the chat! ' + data.text);
                    break;
                
                // NEW: Handle failed join
                case 'joinError':
                    joinErrorMsg.textContent = data.text;
                    joinChatBtn.disabled = false; // Re-enable join button
                    break;

                case 'message':
                    displayMessage(data.name, data.text, false);
                    break;
                case 'system':
                    displaySystemMessage(data.text);
                    break;
                case 'adminSuccess':
                    // Admin login was good!
                    displaySystemMessage('Admin login successful.');
                    adminLoginView.classList.add('hidden');
                    adminControlsView.classList.remove('hidden');
                    break;
                case 'banned':
                    // This client is banned!
                    showBannedScreen(data.link);
                    ws.close(); // Close the connection
                    break;
                case 'bannedWordList':
                    // Received an updated list of banned words
                    updateBannedWordList(data.words);
                    break;
                case 'bannedUserList':
                    // Received an updated list of banned users
                    updateBannedUserList(data.users);
                    break;
            }
        };

        ws.onclose = () => {
            console.log('Disconnected from WebSocket server');
            // Don't show disconnected message if they were banned
            if (bannedOverlay.style.display !== 'flex') {
                displaySystemMessage('You have been disconnected. Please refresh the page to reconnect.');
                sendButton.disabled = true;
                messageInput.disabled = true;
            }
        };

        ws.onerror = (error) => {
            console.error('WebSocket Error:', error);
            // Show error on the join modal if it's still visible
            if (!chatContainer.classList.contains('hidden')) {
                displaySystemMessage('A connection error occurred.');
            } else {
                joinErrorMsg.textContent = 'Could not connect to server.';
            }
        };

        // --- Form Submission Handlers ---
        
        // NEW: Handle joining the chat
        joinChatBtn.addEventListener('click', () => {
            const name = joinUsernameInput.value;
            if (!name) {
                joinErrorMsg.textContent = 'Username cannot be empty.';
                return;
            }
            
            joinErrorMsg.textContent = ''; // Clear error
            joinChatBtn.disabled = true; // Prevent double-click
            
            // This is now the "join" message
            sendSocketMessage({
                type: 'setName',
                name: name
            });
        });
        
        // Handle sending a regular chat message
        messageForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const message = messageInput.value;
            if (!message) return;

            // Send the message as a JSON object
            sendSocketMessage({
                type: 'message',
                text: message
            });
            
            // Display my own message immediately
            displayMessage('You', message, true);

            messageInput.value = ''; // Clear the input
        });

        // Handle saving (changing) the user's name
        saveNameBtn.addEventListener('click', () => {
            const name = nameInput.value;
            if (!name) return;

            sendSocketMessage({
                type: 'setName',
                name: name
            });
            
            // Close the modal after saving
            closeSettingsModal();
        });

        // Handle admin login
        adminLoginBtn.addEventListener('click', () => {
            const password = adminPasswordInput.value;
            if (!password) return;

            sendSocketMessage({
                type: 'adminLogin',
                password: password
            });
            adminPasswordInput.value = ''; // Clear password
        });
        
        // Handle sending an admin broadcast
        adminBroadcastBtn.addEventListener('click', () => {
            const message = adminBroadcastInput.value;
            if (!message) return;
            sendSocketMessage({ type: 'adminBroadcast', text: message });
            adminBroadcastInput.value = ''; // Clear input
        });
        
        // --- New Admin Action Handlers ---

        adminWarnBtn.addEventListener('click', () => {
            const name = adminUsernameInput.value;
            if (!name) return;
            sendSocketMessage({ type: 'adminWarn', name: name });
            adminUsernameInput.value = '';
        });

        adminMuteBtn.addEventListener('click', () => {
            const name = adminUsernameInput.value;
            if (!name) return;
            sendSocketMessage({ type: 'adminMute', name: name });
            adminUsernameInput.value = '';
        });

        adminBanBtn.addEventListener('click', () => {
            const name = adminUsernameInput.value;
            if (!name) return;
            sendSocketMessage({ type: 'adminBan', name: name });
            adminUsernameInput.value = '';
        });
        
        adminAddWordBtn.addEventListener('click', () => {
            const word = adminWordInput.value;
            if (!word) return;
            sendSocketMessage({ type: 'adminAddWord', word: word });
            adminWordInput.value = '';
        });
        
        adminRemoveWordBtn.addEventListener('click', () => {
            const word = adminWordInput.value;
            if (!word) return;
            sendSocketMessage({ type: 'adminRemoveWord', word: word });
            adminWordInput.value = '';
        });


    </script>
</body>
</html>
